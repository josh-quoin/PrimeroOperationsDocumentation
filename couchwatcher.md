# CouchDB CouchWatcher

The CouchDB change watcher monitors CouchDB server and reacts to certain data events:

* New records being created trigger Solr re-indexing

* Changes to the forms metadata trigger rebuilding of the Rails mapping objects that interface with CouchDB and Solr

* Detects and resolves record conflicts generated by bulk updates or CouchDB-to-CouchDB syncs and stored in CouchDB.

The Change Watcher is Ruby on Rails process running on an EventMachine \([https://github.com/eventmachine/eventmachine](https://github.com/eventmachine/eventmachine)\). It is launched by Supervisor. When a new configuration bundle is applied, the Couch Watcher is restarted.

| Start | $ sudo supervisorctl start couch-watcher |
| :--- | :--- |
| Stop | $ sudo supervisorctl stop couch-watcher |
| Status | `$ sudo supervisorctl status`<br>*backburner RUNNING pid 10570, uptime 5:28:23*<br>*couch-watcher RUNNING pid 10580, uptime 5:28:23*<br>*primero-scheduler RUNNING pid 10587, uptime 5:28:23*<br>*solr RUNNING pid 10307, uptime 5:28:23<br>who-watches-the couch watcher RUNNING pid 10555, uptime 5:28:23*<br><br>`$ ps -fA \| grep couch\_changes`<br>primero 10580 1258 0 14:05 ? 00:00:00 bash /srv/primero/.rvm/bin/rvmsudo capsh --drop=all --caps=cap\_dac\_read\_search+ep -- -c RAILS\_ENV=production RAILS\_LOG\_PATH=/srv/primero/logs/couch\_watcher /srv/primero/.rvm/wrappers/default/bundler exec rails runner /srv/primero/application/lib/couch\_changes/base.rbroot 10586 10580 0 14:05 ? 00:00:00 sudo /usr/bin/env PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin rvmsudo\_secure\_path=1 capsh --drop=all --caps=cap\_dac\_read\_search+ep -- -c RAILS\_ENV=production RAILS\_LOG\_PATH=/srv/primero/logs/couch\_watcher /srv/primero/.rvm/wrappers/default/bundler exec rails runner /srv/primero/application/lib/couch\_changes/base.rbroot 10587 10586 0 14:05 ? 00:00:09 /srv/primero/application/lib/couch\_changes/base.rb |
| History file | /srv/primero/application/tmp/couch\_watcher\_history.json |
| Log Files | /srv/primero/logs/couch\_watcher/output.log/srv/primero/logs/couch\_watcher/production.log |
| Run User | root, primero |



